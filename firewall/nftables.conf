# L.Y.N.C Solutions PH
# SEER Device - v1.0
# nftables.conf - Stateful Firewall (Enhanced)
# -------------------------------------------------------------

flush ruleset

define WAN = "eth1"
define LAN = "br0"
define LOOP = "lo"
define SSH_PORT = 22
define DNS_PORT = 53
define DHCP_PORT = 67
define DHCP_CLIENT_PORT = 68
define HTTP_PORT = 80
define NTP_PORT = 123
define HTTPS_PORT = 443
define NODERED_PORT = 1880
define TEMPORAL_PORT = 1889
define FASTAPI_PORT = 5000
define TAILNET = 100.64.0.0/10
define LAN_NET = 192.168.50.0/24
# -------------------------------------------------------------
table inet filter {
        # Rate limiting sets
        set ssh_ratelimit {
                type ipv4_addr
                size 65536
                flags dynamic,timeout
                timeout 10m
        }

        set icmp_ratelimit {
                type ipv4_addr
                size 65536
                flags dynamic,timeout
                timeout 1m
        }

        set blacklist_v4 {
                type ipv4_addr
                flags timeout
        }

        set blacklist_v6 {
                type ipv6_addr
                flags timeout
        }

        set allowed_out_services {
                type inet_service
                elements = { 53, 80, 123, 443 }
        }

        # Logging chains
        chain log_drop {
                log prefix "[NFT DROP] " level warn flags all counter
                drop
        }

        chain log_accept {
                log prefix "[NFT ACCEPT] " level info counter
                accept
        }

        # DoS protection chains
        chain wan_conn_rate {
                iifname $WAN ct state new limit rate 50/second burst 100 packets counter return
                iifname $WAN ct state new counter drop
        }

        chain wan_syn_flood {
                iifname $WAN tcp flags & (fin|syn|rst|ack) == syn limit rate 50/second burst 100 packets counter return
                iifname $WAN tcp flags & (fin|syn|rst|ack) == syn counter drop
        }

        # -------------------------------------------------------------
        # INPUT (Traffic TO firewall)
        chain input {
                type filter hook input priority filter
                policy drop

                # DHCP FIRST - before any drops (DISCOVER uses 0.0.0.0 source)
                # DHCP server on LAN - accept all DHCP traffic
                iifname $LAN udp sport $DHCP_CLIENT_PORT udp dport $DHCP_PORT accept
                iifname $LAN udp sport $DHCP_PORT udp dport $DHCP_CLIENT_PORT accept
                # DHCP client on WAN - accept ISP DHCP replies
                iifname $WAN udp sport $DHCP_PORT udp dport $DHCP_CLIENT_PORT accept

                # Drop blacklisted IPs early
                ip saddr @blacklist_v4 counter drop
                ip6 saddr @blacklist_v6 counter drop

                # Drop invalid packets immediately
                ct state invalid counter drop

                # Allow loopback (essential for system stability)
                iifname $LOOP accept

                # Stateful connection tracking (CRITICAL for stability)
                ct state { established, related } accept

                # WAN-only DoS protections (rate-limit new connections/SYN)
                jump wan_conn_rate
                jump wan_syn_flood

                # WAN anti-spoof (RFC 1918, RFC 3927, RFC 5735) - WAN ONLY!
                iifname $WAN ip saddr {
                        10.0.0.0/8,
                        172.16.0.0/12,
                        192.168.0.0/16,
                        127.0.0.0/8,
                        169.254.0.0/16,
                        224.0.0.0/4,
                        240.0.0.0/4
                } counter drop

                # TCP flag validation (port scan protection)
                tcp flags & (fin|syn|rst|psh|ack|urg) == 0 counter drop
		
		# Allowing Node-Red (Remote)
		tcp dport $NODERED_PORT ip saddr $TAILNET accept

		# Allow Temporal Policy Port (Remote)
		tcp dport $TEMPORAL_PORT ip saddr $TAILNET accept

		# Allow FastAPI (Remote)
		tcp dport $FASTAPI_PORT ip saddr $TAILNET accept
		
		# Allow Temporal Policy from LAN
		iifname $LAN tcp dport $TEMPORAL_PORT accept

		# Allow FastAPI from LAN
		iifname $LAN tcp dport $FASTAPI_PORT accept		

                # LAN access
                iifname $LAN accept
		
                # DNS queries to firewall resolver (LAN only)
                iifname $LAN udp dport $DNS_PORT ct state new,established accept
                iifname $LAN tcp dport $DNS_PORT ct state new,established accept

                # ICMP handling (LAN unrestricted, WAN limited)
                iifname != $WAN ip protocol icmp accept
                iifname $WAN ip protocol icmp limit rate 10/second burst 20 packets add @icmp_ratelimit { ip saddr timeout 1m } accept
                iifname $WAN ip protocol icmp counter drop
                iifname != $WAN ip6 nexthdr icmpv6 accept
                iifname $WAN ip6 nexthdr icmpv6 limit rate 10/second burst 20 packets accept
                iifname $WAN ip6 nexthdr icmpv6 counter drop

                # SSH with rate limiting
                tcp dport $SSH_PORT ip saddr $TAILNET accept
                iifname $WAN tcp dport $SSH_PORT ct state new limit rate 4/minute burst 10 packets accept
                iifname $WAN tcp dport $SSH_PORT ct state new add @ssh_ratelimit { ip saddr timeout 10m } counter drop

                # Log and drop everything else
                counter jump log_drop
        }

        # -------------------------------------------------------------
        # FORWARD (traffic THRU firewall)
        chain forward {
                type filter hook forward priority filter
                policy drop

                # Drop blacklisted IPs early
                ip saddr @blacklist_v4 counter drop
                ip6 saddr @blacklist_v6 counter drop

                # Drop invalid packets immediately
                ct state invalid counter drop

                # Stateful connection tracking (CRITICAL - allows return traffic)
                ct state established, related accept

                # WAN-only DoS protections for forwarded traffic
                jump wan_conn_rate
                jump wan_syn_flood

                # LAN → WAN (allow all outbound from LAN clients)
                iifname $LAN oifname $WAN accept

                # WAN → LAN return traffic is handled by established,related above
                # Explicit drop for unsolicited WAN → LAN
                iifname $WAN oifname $LAN counter jump log_drop
        }

        # -------------------------------------------------------------
        # OUTPUT (traffic FROM firewall)
        chain output {
                type filter hook output priority filter
                policy accept

                # Allow loopback
                oifname $LOOP accept

                # DHCP server responses on LAN (before conntrack - no state for broadcasts)
                oifname $LAN udp sport $DHCP_PORT udp dport $DHCP_CLIENT_PORT accept
                oifname $LAN udp sport $DHCP_CLIENT_PORT udp dport $DHCP_PORT accept

                # Stateful connections
                ct state established,related accept
                ct state invalid counter drop

                # Firewall → LAN
                oifname $LAN accept

                # Firewall → WAN (system updates, time sync, DHCP renewals)
                oifname $WAN udp sport $DHCP_CLIENT_PORT udp dport $DHCP_PORT accept
                oifname $WAN udp dport { $DNS_PORT, $NTP_PORT } accept
                oifname $WAN tcp dport @allowed_out_services accept

                # Log unexpected output
                counter
        }
}

# -------------------------------------------------------------
# NAT (Network Address Translation)
table ip nat {
        chain prerouting {
                type nat hook prerouting priority dstnat
                policy accept
        }

        chain postrouting {
                type nat hook postrouting priority srcnat
                policy accept

                # Masquerade LAN traffic (with connection tracking)
                oifname $WAN ip saddr $LAN_NET counter masquerade fully-random
        }
}

# -------------------------------------------------------------
# Connection Tracking Optimization (RPi CM4/RPi4)
table inet conntrack {
        chain prerouting {
                type filter hook prerouting priority raw
                policy accept

                # DHCP traffic must bypass conntrack (broadcasts don't track)
                iifname $LAN udp sport $DHCP_CLIENT_PORT udp dport $DHCP_PORT notrack
                iifname $LAN udp sport $DHCP_PORT udp dport $DHCP_CLIENT_PORT notrack
                iifname $WAN udp sport $DHCP_PORT udp dport $DHCP_CLIENT_PORT notrack

                # Optimize conntrack for RPi memory constraints
                # Reduce tracking for high-volume low-risk traffic
                # tcp dport { $HTTP_PORT, $HTTPS_PORT } notrack
        }

        chain output {
                type filter hook output priority raw
                policy accept

                # DHCP server responses must bypass conntrack
                oifname $LAN udp sport $DHCP_PORT udp dport $DHCP_CLIENT_PORT notrack
                oifname $LAN udp sport $DHCP_CLIENT_PORT udp dport $DHCP_PORT notrack
                oifname $WAN udp sport $DHCP_CLIENT_PORT udp dport $DHCP_PORT notrack

                # Don't track loopback
                oifname $LOOP notrack
        }
}

# -------------------------------------------------------------
# EOF
# L.Y.N.C Solutions PH
# SEER Device - v1.0
# nftables.conf - Stateful Firewall (Enhanced)
